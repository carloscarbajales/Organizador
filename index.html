<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Tareas Multi-Farmacia</title>
    <script src="https://cdn-tailwindcss.vercel.app/"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            getFirestore,
            doc,
            getDoc,
            setDoc,
            onSnapshot,
            updateDoc
        };
    </script>
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #25af0f;
        }
        .calendar-grid {
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        .toast {
            animation: slide-in 0.5s forwards, slide-out 0.5s 5s forwards;
        }
        @keyframes slide-in {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes slide-out {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(100%); opacity: 0; }
        }
        .app-locked .protected-control, .app-locked .calendar-grid > div, .app-locked #employee-list button {
            pointer-events: none;
            opacity: 0.7;
        }
        .app-locked .protected-control {
             cursor: not-allowed;
        }
        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                background-color: #ffffff;
            }
            aside, button, #toast-container, #taskModal, #completedTasksModal, #passwordModal, #changePasswordModal, #managePharmaciesModal, #prev-month, #next-month, #clear-filters-btn, #login-screen {
                display: none !important;
            }
            #app, main {
                display: block !important;
                width: 100% !important;
                padding: 0 !important;
                border: none !important;
                height: auto !important;
                overflow: visible !important;
            }
            #current-month-year {
                font-size: 1.5rem;
                text-align: center;
                width: 100%;
            }
            .calendar-grid {
                gap: 0;
            }
            .calendar-grid > div:not(.bg-gray-50) {
                border: 1px solid #ccc;
                min-height: 110px;
                page-break-inside: avoid;
            }
            .bg-gray-50 {
                border: none;
            }
            .taskEl {
                color: black !important;
                background: transparent !important;
                padding: 2px 4px !important;
                margin-bottom: 2px !important;
                border-radius: 2px !important;
                font-size: 9pt !important;
            }
            .taskEl[data-type="inaplazable"] { border-left: 4px solid #ef4444; background-color: #fee2e2 !important; }
            .taskEl[data-type="flexible"] { border-left: 4px solid #f97316; background-color: #ffedd5 !important; }
            .taskEl[data-type="anual"] { border-left: 4px solid #3b82f6; background-color: #dbeafe !important; }
            .taskEl[data-type="recurrente"] { border-left: 4px solid #8b5cf6; background-color: #ede9fe !important; }
            .taskEl[data-type="puntual"] { border-left: 4px solid #6b7280; background-color: #f3f4f6 !important; }

            .line-through { text-decoration: line-through; }
            .opacity-60 { opacity: 0.7; }
            .text-white { color: black !important; }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Pantalla de Carga Inicial -->
    <div id="loading-screen" class="flex flex-col items-center justify-center h-screen">
        <div class="loader"></div>
        <p class="mt-4 text-white">Conectando...</p>
    </div>

    <!-- Pantalla de Login -->
    <div id="login-screen" class="hidden items-center justify-center h-screen">
        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold text-center mb-2" style="color: #25af0f;">Gestor de Tareas</h1>
            <p class="text-center text-gray-500 mb-8">Acceso a Farmacias</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="pharmacy-select" class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Farmacia</label>
                    <select id="pharmacy-select" class="w-full border-gray-300 rounded-lg shadow-sm" required>
                        <!-- Opciones de farmacia se cargarán aquí -->
                    </select>
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <input type="password" id="login-password" class="w-full border-gray-300 rounded-lg shadow-sm" required>
                </div>
                 <p id="login-error" class="text-red-500 text-sm text-center mt-2 h-4 mb-4"></p>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                    Entrar
                </button>
            </form>
             <p id="initial-setup-message" class="hidden text-center text-sm text-gray-500 mt-4">
                Primer inicio detectado. La primera contraseña que establezcas será la del Administrador.
            </p>
        </div>
    </div>

    <!-- Contenedor Principal de la App (inicialmente oculto) -->
    <div id="app" class="hidden flex-col lg:flex-row h-screen">

        <!-- Panel Lateral (Información y Controles) -->
        <aside class="w-full lg:w-1/3 xl:w-1/4 p-6 bg-white border-r border-gray-200 flex flex-col space-y-6 overflow-y-auto">
            <header class="flex justify-between items-start">
                <div>
                    <h1 id="pharmacy-name-header" class="text-2xl font-bold" style="color: #25af0f;"></h1>
                    <p class="text-gray-500">Planificador Mensual</p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="lock-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                        <!-- Icono de candado se insertará aquí -->
                    </button>
                    <button id="logout-btn" title="Salir" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    </button>
                </div>
            </header>

            <button id="addTaskBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-300 protected-control">
                Añadir Nueva Tarea
            </button>
             <button id="review-completed-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-lg shadow-sm hover:bg-gray-300 transition-colors duration-300">
                Revisar Tareas Completadas
            </button>
            <button id="print-view-btn" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg shadow-sm hover:bg-teal-700 transition-colors duration-300">
                Vista Imprimible
            </button>
            
             <!-- Filtros -->
            <div>
                <h2 class="text-lg font-semibold mb-3 border-b pb-2">Filtros</h2>
                <div class="space-y-3">
                    <div>
                        <label for="filter-employee" class="text-sm font-medium">Empleado:</label>
                        <select id="filter-employee" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">Todos</option>
                        </select>
                    </div>
                    <div>
                        <label for="filter-type" class="text-sm font-medium">Tipo de Tarea:</label>
                        <select id="filter-type" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">Todos</option>
                            <option value="inaplazable">Inaplazable</option>
                            <option value="flexible">Flexible</option>
                            <option value="anual">Anual</option>
                            <option value="recurrente">Recurrente</option>
                            <option value="puntual">Puntual</option>
                        </select>
                    </div>
                    <button id="clear-filters-btn" class="w-full text-sm text-blue-600 hover:underline">Limpiar Filtros</button>
                </div>
            </div>

            <!-- Sección de Empleados y Tiempos -->
            <div>
                <h2 class="text-lg font-semibold mb-3 border-b pb-2">Resumen por Empleado</h2>
                <div id="employee-report" class="space-y-3">
                    <!-- El reporte se generará aquí -->
                </div>
            </div>

            <!-- Sección de Gestión de Empleados -->
            <div class="protected-control">
                <h2 class="text-lg font-semibold mb-3 border-b pb-2">Gestionar Empleados</h2>
                <form id="add-employee-form" class="flex gap-2 mb-3">
                    <input type="text" id="new-employee-name" placeholder="Nombre del empleado" class="w-full border-gray-300 rounded-lg shadow-sm text-sm" required>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 text-sm">Añadir</button>
                </form>
                <div id="employee-list" class="space-y-2">
                    <!-- Lista de empleados se generará aquí -->
                </div>
            </div>
            
            <!-- Seguridad -->
            <div class="protected-control">
                 <h2 class="text-lg font-semibold mb-3 border-b pb-2">Seguridad</h2>
                 <button id="change-password-btn" class="w-full text-sm text-blue-600 hover:underline text-left">Cambiar Contraseña</button>
            </div>

            <!-- Admin -->
            <div id="admin-controls" class="hidden protected-control">
                <h2 class="text-lg font-semibold mb-3 border-b pb-2">Administración</h2>
                <button id="manage-pharmacies-btn" class="w-full text-sm text-blue-600 hover:underline text-left">Gestionar Farmacias</button>
           </div>
            
        </aside>

        <!-- Área Principal (Calendario) -->
        <main class="flex-1 p-6 flex flex-col bg-gray-50">
            <!-- Cabecera del Calendario -->
            <div class="flex items-center justify-between mb-4">
                <button id="prev-month" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <h2 id="current-month-year" class="text-xl font-bold text-center"></h2>
                <button id="next-month" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>

            <!-- Días de la semana -->
            <div class="grid calendar-grid text-center font-semibold text-sm text-gray-600 mb-2">
                <div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div>
            </div>

            <!-- Grid del Calendario -->
            <div id="calendar-grid" class="grid calendar-grid flex-1 gap-2">
                <!-- Los días se generarán aquí -->
            </div>
        </main>
    </div>

    <!-- Modal para Añadir/Editar Tarea -->
    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-8 transform transition-all scale-95 opacity-0">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Nueva Tarea</h2>
            <form id="task-form">
                <input type="hidden" id="task-id">
                <input type="hidden" id="task-status">
                <input type="hidden" id="task-instance-date">
                
                <div class="mb-4">
                    <label for="task-title" class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                    <input type="text" id="task-title" class="w-full border-gray-300 rounded-lg shadow-sm" required>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="task-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                        <select id="task-type" class="w-full border-gray-300 rounded-lg shadow-sm" required>
                            <option value="puntual">Puntual</option>
                            <option value="inaplazable">Inaplazable</option>
                            <option value="flexible">Flexible</option>
                            <option value="recurrente">Recurrente</option>
                            <option value="anual">Anual</option>
                        </select>
                    </div>
                    <div id="recurrence-container" class="hidden">
                         <div class="mb-2">
                            <label for="task-recurrence-type" class="block text-sm font-medium text-gray-700 mb-1">Frecuencia</label>
                            <select id="task-recurrence-type" class="w-full border-gray-300 rounded-lg shadow-sm">
                                <option value="weekly">Semanal</option>
                                <option value="monthly">Mensual</option>
                            </select>
                        </div>
                        <div id="recurrence-weekly-container">
                             <fieldset>
                                <legend class="block text-sm font-medium text-gray-700 mb-2">Repetir los días</legend>
                                <div id="task-recurrence-days" class="grid grid-cols-3 sm:grid-cols-4 gap-2 text-sm">
                                    <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" value="1"><span>Lun</span></label>
                                    <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" value="2"><span>Mar</span></label>
                                    <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" value="3"><span>Mié</span></label>
                                    <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" value="4"><span>Jue</span></label>
                                    <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" value="5"><span>Vie</span></label>
                                    <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" value="6"><span>Sáb</span></label>
                                    <label class="flex items-center space-x-2 p-2 border rounded-md"><input type="checkbox" value="0"><span>Dom</span></label>
                                </div>
                            </fieldset>
                        </div>
                        <div id="recurrence-monthly-container" class="hidden">
                            <label for="task-recurrence-day-month" class="block text-sm font-medium text-gray-700 mb-1">Día del mes</label>
                            <input type="number" id="task-recurrence-day-month" min="1" max="31" class="w-full border-gray-300 rounded-lg shadow-sm" placeholder="Ej: 15">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4" id="dates-container">
                    <div id="start-date-container">
                        <label for="task-start-date" class="block text-sm font-medium text-gray-700 mb-1">Fecha Inicio</label>
                        <input type="date" id="task-start-date" class="w-full border-gray-300 rounded-lg shadow-sm">
                    </div>
                    <div id="due-date-container">
                        <label for="task-due-date" class="block text-sm font-medium text-gray-700 mb-1">Fecha Fin</label>
                        <input type="date" id="task-due-date" class="w-full border-gray-300 rounded-lg shadow-sm">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="task-assigned-to" class="block text-sm font-medium">Asignar a</label>
                        <select id="task-assigned-to" class="w-full border-gray-300 rounded-lg shadow-sm"> </select>
                    </div>
                    <div>
                        <label for="task-time" class="block text-sm font-medium">Tiempo Estimado (min)</label>
                        <input type="number" id="task-time" min="0" step="5" class="w-full border-gray-300 rounded-lg shadow-sm" required>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="task-url" class="block text-sm font-medium text-gray-700 mb-1">Enlace Web (Opcional)</label>
                    <input type="url" id="task-url" placeholder="https://ejemplo.com" class="w-full border-gray-300 rounded-lg shadow-sm">
                </div>

                <div class="flex justify-between items-center mt-8">
                    <div>
                        <button type="button" id="delete-task-btn" class="hidden text-red-600 hover:text-red-800 font-medium">Eliminar</button>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button type="button" id="toggle-status-btn" class="hidden px-4 py-2 bg-green-100 text-green-800 rounded-lg hover:bg-green-200 font-medium"></button>
                        <button type="button" id="cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Guardar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para Revisar Tareas Completadas -->
    <div id="completedTasksModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 transform transition-all scale-95 opacity-0 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                 <h2 class="text-2xl font-bold">Tareas Completadas</h2>
                 <button id="close-completed-modal-btn" class="p-2 rounded-full hover:bg-gray-200">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                 </button>
            </div>
            <div id="completed-tasks-list" class="overflow-y-auto">
                <!-- La lista de tareas completadas se generará aquí -->
            </div>
        </div>
    </div>

    <!-- Modal de Contraseña (Genérico para desbloquear) -->
    <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-8 transform transition-all scale-95 opacity-0">
            <h2 class="text-2xl font-bold mb-6 text-center">Desbloquear</h2>
            <form id="password-form">
                <p class="text-center text-gray-600 mb-4">Introduce la contraseña para hacer cambios.</p>
                <input type="password" id="password-input" class="w-full border-gray-300 rounded-lg shadow-sm text-center" required>
                <p id="password-error" class="text-red-500 text-sm text-center mt-2 h-4"></p>
                <div class="flex items-center space-x-4 mt-6">
                    <button type="button" id="cancel-password-btn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="w-full px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Desbloquear</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Cambiar Contraseña -->
    <div id="changePasswordModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-8 transform transition-all scale-95 opacity-0">
            <h2 id="change-password-title" class="text-2xl font-bold mb-6">Cambiar Contraseña</h2>
            <form id="change-password-form">
                <div class="mb-4">
                    <label for="current-password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña Actual</label>
                    <input type="password" id="current-password" class="w-full border-gray-300 rounded-lg shadow-sm" required>
                </div>
                <div class="mb-4">
                    <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">Nueva Contraseña</label>
                    <input type="password" id="new-password" class="w-full border-gray-300 rounded-lg shadow-sm" required>
                </div>
                 <div class="mb-4 hidden" id="admin-reset-container">
                    <label for="admin-reset-pharmacy-select" class="block text-sm font-medium text-gray-700 mb-1">Resetear contraseña de Gerente para:</label>
                    <select id="admin-reset-pharmacy-select" class="w-full border-gray-300 rounded-lg shadow-sm"></select>
                </div>
                <p id="change-password-error" class="text-red-500 text-sm mt-2 h-4"></p>
                <div class="flex items-center space-x-4 mt-6">
                    <button type="button" id="cancel-change-password-btn" class="w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="w-full px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Gestionar Farmacias (Admin) -->
    <div id="managePharmaciesModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 transform transition-all scale-95 opacity-0 flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                 <h2 class="text-2xl font-bold">Gestionar Farmacias</h2>
                 <button id="close-manage-pharmacies-modal-btn" class="p-2 rounded-full hover:bg-gray-200">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                 </button>
            </div>
            <div id="pharmacy-management-list" class="overflow-y-auto mb-6 flex-1 pr-2">
                <!-- Lista se generará aquí -->
            </div>
            <form id="add-pharmacy-form">
                <h3 class="text-lg font-semibold mb-3 border-t pt-4">Añadir Nueva Farmacia</h3>
                <div class="flex gap-2">
                    <input type="text" id="new-pharmacy-name" placeholder="Nombre de la nueva farmacia" class="w-full border-gray-300 rounded-lg shadow-sm" required>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">Añadir</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contenedor de Notificaciones (Toast) -->
    <div id="toast-container" class="fixed bottom-0 right-0 p-6 space-y-3 z-50 w-full max-w-sm"></div>

    <script type="module">
    document.addEventListener('DOMContentLoaded', async () => {
        // --- INSTANCIAS Y CONFIGURACIÓN DE FIREBASE ---
        let db, auth;
        let unsubscribePharmacyData = () => {}; // Función para cancelar la suscripción de onSnapshot
        
        // --- ESTADO Y DATOS LOCALES ---
        let currentDate = new Date();
        let tasks = [];
        let employees = [];
        let isLocked = true;
        
        // --- ESTADO GLOBAL DE LA APP ---
        let currentPharmacyId = null;
        let isAdminSession = false;
        let allPharmacies = [];
        let allPasswords = {};

        const employeeColorPalette = [
            { bg: 'bg-blue-100', text: 'text-blue-800' },
            { bg: 'bg-green-100', text: 'text-green-800' },
            { bg: 'bg-yellow-100', text: 'text-yellow-800' },
            { bg: 'bg-purple-100', text: 'text-purple-800' },
            { bg: 'bg-pink-100', text: 'text-pink-800' },
            { bg: 'bg-indigo-100', text: 'text-indigo-800' },
            { bg: 'bg-red-100', text: 'text-red-800' },
            { bg: 'bg-teal-100', text: 'text-teal-800' }
        ];
        const defaultEmployeeColor = { bg: 'bg-gray-100', text: 'text-gray-800' };
        const taskTypeBorders = { 
            inaplazable: 'border-red-500', 
            flexible: 'border-orange-500', 
            anual: 'border-blue-500', 
            recurrente: 'border-purple-500', 
            puntual: 'border-gray-500' 
        };
        let filters = { employee: 'all', type: 'all' };

        // --- SELECTORES DEL DOM ---
        const loadingScreen = document.getElementById('loading-screen');
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app');
        const lockBtn = document.getElementById('lock-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const calendarGrid = document.getElementById('calendar-grid');
        const currentMonthYearEl = document.getElementById('current-month-year');
        const taskModal = document.getElementById('taskModal');
        const taskForm = document.getElementById('task-form');
        const toastContainer = document.getElementById('toast-container');
        const taskRecurrenceType = document.getElementById('task-recurrence-type');
        const recurrenceWeeklyContainer = document.getElementById('recurrence-weekly-container');
        const recurrenceMonthlyContainer = document.getElementById('recurrence-monthly-container');
        const pharmacyNameHeader = document.getElementById('pharmacy-name-header');
        // Filtros y reportes
        const filterEmployeeSelect = document.getElementById('filter-employee');
        const filterTypeSelect = document.getElementById('filter-type');
        const employeeReportEl = document.getElementById('employee-report');
        // Gestión de Empleados
        const addEmployeeForm = document.getElementById('add-employee-form');
        const newEmployeeNameInput = document.getElementById('new-employee-name');
        const employeeListEl = document.getElementById('employee-list');
        // Tareas completadas
        const reviewCompletedBtn = document.getElementById('review-completed-btn');
        const completedTasksModal = document.getElementById('completedTasksModal');
        const completedTasksListEl = document.getElementById('completed-tasks-list');
        const closeCompletedModalBtn = document.getElementById('close-completed-modal-btn');
        const printViewBtn = document.getElementById('print-view-btn');
        // Login & Seguridad
        const loginForm = document.getElementById('login-form');
        const pharmacySelect = document.getElementById('pharmacy-select');
        const passwordModal = document.getElementById('passwordModal');
        const passwordForm = document.getElementById('password-form');
        const changePasswordModal = document.getElementById('changePasswordModal');
        const changePasswordForm = document.getElementById('change-password-form');
        const changePasswordBtn = document.getElementById('change-password-btn');
        // Admin
        const adminControls = document.getElementById('admin-controls');
        const managePharmaciesBtn = document.getElementById('manage-pharmacies-btn');
        const managePharmaciesModal = document.getElementById('managePharmaciesModal');
        const closeManagePharmaciesModalBtn = document.getElementById('close-manage-pharmacies-modal-btn');
        const addPharmacyForm = document.getElementById('add-pharmacy-form');
        const pharmacyManagementList = document.getElementById('pharmacy-management-list');

        // --- FUNCIONES DE GUARDADO Y SEGURIDAD ---
        const toISODateString = (date) => {
            if (!date) return null;
            const d = new Date(date);
            d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
            return d.toISOString().split('T')[0];
        };
        
        const hashCode = (str) => {
          let hash = 0;
          for (let i = 0, len = str.length; i < len; i++) {
            let chr = str.charCodeAt(i);
            hash = (hash << 5) - hash + chr;
            hash |= 0; 
          }
          return hash.toString();
        };

        // --- FUNCIONES DE FIREBASE ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Definición de referencias a documentos de Firestore
        const getPharmaciesRef = () => window.firebase.doc(db, `artifacts/${appId}/public/data/config`, 'pharmacies');
        const getPasswordsRef = () => window.firebase.doc(db, `artifacts/${appId}/public/data/config`, 'passwords');
        const getPharmacyDataRef = (pharmacyId) => window.firebase.doc(db, `artifacts/${appId}/public/data/pharmacyData`, String(pharmacyId));
        
        async function loadGlobalData() {
            const pharmaciesDoc = await window.firebase.getDoc(getPharmaciesRef());
            if (pharmaciesDoc.exists() && pharmaciesDoc.data().list) {
                allPharmacies = pharmaciesDoc.data().list;
            } else {
                await generateInitialPharmacies();
            }

            const passwordsDoc = await window.firebase.getDoc(getPasswordsRef());
            if (passwordsDoc.exists()) {
                allPasswords = passwordsDoc.data();
            } else {
                 document.getElementById('initial-setup-message').classList.remove('hidden');
            }
        }

        async function generateInitialPharmacies() {
            const pharmacyNames = ["ALBUFERA","ALCORCON","ANTONIO LEYVA","ARANJUEZ","ARGANDA","ARROYO DEL OLIVAR","ATOCHA","AVENIDA BRUSELAS","AVENIDA PUERTO","BENIDORM","BETANZOS","BURJASSOT","CAMPANAR","CANILLEJAS","CARRETERIA","CASTELO","CHAMARTIN","DELICIAS","ESPAÑA","EUROPA","EZEQUIEL SOLANA","FUENGIROLA","FUENLABRADA","GETAFE","GUILLEM DE CASTRO","GUZMAN EL BUENO","HERNANI","LA ELIANA","LAGOH","LEGANES","LUCHANA","MAJADAHONDA","MARIO CABRE","MARQUES DE LA VALDAVIA","MARQUES DE ZAFRA","MARTINEZ DE LA RIVA","MEDITERRANEO","MOLINA DE SEGURA","MONFORTE","MONTEOLIVETE","MORATALAZ","MOSTOLES","MOSTOLES SOTO","NIZA","NOBLEJAS","OPORTO","ORENSE","PARLA ESTE","PASEO DE EXTREMADURA","PAU 5, PLAYA SAN JUAN","PEÑALVER","POZUELO","QUIÑON","REQUENA","RETIRO","SAN BLAS","SAN FERNANDO","SAN JAIME","SAN JOSE DE VALDERAS","SAN MARTIN DE LA VEGA","TORREJON","TORRELAGUNA","TORREVIEJA","TRES FORQUES","TRINITAT","URGEL","URQUIJO","USERA","VALDEBEBAS","VALL DE UXO","VALLADOLID","VICTOR DE LA SERNA","VILLAVERDE","XIRIVELLA","ZARZAQUEMADA"];
            allPharmacies = pharmacyNames.map((name, index) => ({ id: index + 1, name: name }));
            await window.firebase.setDoc(getPharmaciesRef(), { list: allPharmacies });
        }

        async function saveAllPharmacies() {
             await window.firebase.setDoc(getPharmaciesRef(), { list: allPharmacies });
        }
        
        async function savePasswords() {
            await window.firebase.setDoc(getPasswordsRef(), allPasswords);
        }

        async function savePharmacyData() {
            if (!currentPharmacyId) return;
            await window.firebase.setDoc(getPharmacyDataRef(currentPharmacyId), { tasks, employees });
        }

        function listenToPharmacyData(pharmacyId) {
            unsubscribePharmacyData(); // Cancelar la escucha anterior
            const pharmacyDataRef = getPharmacyDataRef(pharmacyId);
            unsubscribePharmacyData = window.firebase.onSnapshot(pharmacyDataRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    tasks = data.tasks || [];
                    employees = data.employees || [];
                } else {
                    // Si no existe, creamos los empleados por defecto
                    employees = [
                        { id: 1, name: 'Gerente' }, { id: 2, name: 'Adjunto Gt' }, { id: 3, name: 'Dinamizador Dermo' },
                        { id: 4, name: 'Equipo 1' }, { id: 5, name: 'Equipo 2' }, { id: 6, name: 'Equipo 3' },
                        { id: 7, name: 'Equipo 4' }, { id: 8, name: 'Equipo 5' }
                    ];
                    tasks = [];
                    savePharmacyData(); // Guardamos el estado inicial en Firestore
                }
                renderAll();
            });
        }


        // --- FUNCIONES AUXILIARES DE COLOR ---
        const getEmployeeColor = (employeeId) => {
            const employeeIndex = employees.findIndex(e => e.id === employeeId);
            if (employeeIndex === -1 || employeeId === null) {
                return defaultEmployeeColor;
            }
            return employeeColorPalette[employeeIndex % employeeColorPalette.length];
        };

        // --- FUNCIONES DE RENDERIZADO Y UI ---
        const renderAll = () => {
            renderCalendar();
            renderEmployeeUI();
            updateLockUI();
            updateAdminUI();
        };

        const renderCalendar = () => {
            calendarGrid.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            currentMonthYearEl.textContent = `${currentDate.toLocaleString('es-ES', { month: 'long' })} ${year}`;
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dayOffset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;
            for (let i = 0; i < dayOffset; i++) {
                calendarGrid.innerHTML += `<div class="bg-gray-50 rounded-lg"></div>`;
            }

            const filteredTasks = tasks.filter(task => (filters.employee === 'all' || task.assignedTo == filters.employee) && (filters.type === 'all' || task.type === filters.type));

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(Date.UTC(year, month, day));
                const dateString = toISODateString(date);
                const dayEl = document.createElement('div');
                dayEl.className = 'border border-gray-200 bg-white rounded-lg p-2 flex flex-col min-h-[120px] cursor-pointer';
                
                const today = new Date();
                const dayNumberClass = date.toDateString() === today.toDateString() ? 'font-bold text-blue-600' : 'text-sm';
                dayEl.innerHTML = `<div class="text-center ${dayNumberClass} mb-1">${day}</div>`;

                const tasksForDay = getTasksForDate(date, filteredTasks);
                const tasksContainer = document.createElement('div');
                tasksContainer.className = 'space-y-1 overflow-y-auto flex-1';

                tasksForDay.forEach(task => {
                    const taskEl = document.createElement('div');
                    taskEl.dataset.type = task.type;
                    const employeeColor = getEmployeeColor(task.assignedTo);
                    const typeBorderColor = taskTypeBorders[task.type] || 'border-gray-400';
                    
                    let isCompletedToday = false;
                    if (task.recurrence || task.type === 'flexible') {
                         if (task.type === 'flexible' && !task.recurrence) {
                            isCompletedToday = task.status === 'completada';
                        } else {
                            isCompletedToday = task.completedDates.includes(dateString);
                        }
                    } else {
                        isCompletedToday = task.status === 'completada';
                    }

                    taskEl.className = `taskEl text-xs p-1.5 rounded-md border-l-4 font-medium ${employeeColor.bg} ${employeeColor.text} ${typeBorderColor} flex justify-between items-center`;

                    let taskHTML = `<span>${task.title}</span>`;
                    if (task.url) {
                         taskHTML += `<a href="${task.url}" target="_blank" class="text-blue-500 hover:text-blue-700 ml-2" onclick="event.stopPropagation();">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                            </svg>
                          </a>`;
                    }
                    
                    if (isCompletedToday) {
                        taskEl.classList.add('opacity-60');
                        taskEl.innerHTML = `<span class="font-semibold line-through">${taskHTML}</span>`;
                    } else {
                        taskEl.innerHTML = `<span class="font-semibold">${taskHTML}</span>`;
                    }
                    taskEl.addEventListener('click', (e) => { e.stopPropagation(); openModal(task, dateString); });
                    tasksContainer.appendChild(taskEl);
                });

                dayEl.appendChild(tasksContainer);
                dayEl.addEventListener('click', () => openModal(null, dateString));
                calendarGrid.appendChild(dayEl);
            }
        };

        const getTasksForDate = (date, taskList) => {
            const dateString = toISODateString(date);
            const dayOfMonth = date.getUTCDate();
            const dayOfWeek = date.getUTCDay();
            return taskList.filter(task => {
                if (task.type === 'flexible' && task.recurrence?.type === 'monthly') {
                    return dayOfMonth >= parseInt(task.startDate) && dayOfMonth <= parseInt(task.dueDate);
                }
                
                if (task.type === 'recurrente' && task.recurrence) {
                    if (task.recurrence.type === 'weekly' && task.recurrence.days) {
                        return task.recurrence.days.includes(String(dayOfWeek));
                    }
                    if (task.recurrence.type === 'monthly' && task.recurrence.dayOfMonth) {
                        return dayOfMonth == task.recurrence.dayOfMonth;
                    }
                }

                if ((task.type === 'flexible' || task.type === 'anual') && !task.recurrence) {
                     if (task.status === 'completada') {
                        return dateString === task.completionDate;
                    }
                    return dateString >= task.startDate && dateString <= task.dueDate;
                }
                
                return task.dueDate === dateString;
            });
        };

        const formatTime = (minutes) => {
            if (!minutes || minutes < 1) return '0m';
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${h > 0 ? `${h}h ` : ''}${m}m`;
        };

        const renderEmployeeUI = () => {
            employeeListEl.innerHTML = '';
            employees.forEach(emp => {
                const empEl = document.createElement('div');
                const color = getEmployeeColor(emp.id);
                empEl.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-lg text-sm';
                empEl.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="w-3 h-3 rounded-full ${color.bg} border border-gray-300"></span>
                        <span>${emp.name}</span>
                    </div>
                    <button data-id="${emp.id}" class="text-red-500 hover:text-red-700 font-bold">X</button>
                `;
                employeeListEl.appendChild(empEl);
            });

            const assignedToSelect = document.getElementById('task-assigned-to');
            assignedToSelect.innerHTML = '<option value="">Sin asignar</option>';
            filterEmployeeSelect.innerHTML = '<option value="all">Todos</option>';
            employees.forEach(emp => {
                assignedToSelect.innerHTML += `<option value="${emp.id}">${emp.name}</option>`;
                filterEmployeeSelect.innerHTML += `<option value="${emp.id}">${emp.name}</option>`;
            });
            filterEmployeeSelect.value = filters.employee;

            employeeReportEl.innerHTML = '';
            employees.forEach(employee => {
                let totalTime = 0;
                let completedTime = 0;
                const month = currentDate.getMonth();
                const year = currentDate.getFullYear();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                tasks.filter(t => t.assignedTo === employee.id).forEach(task => {
                    if (task.type === 'flexible' && task.recurrence?.type === 'monthly') {
                        totalTime += task.estimatedTime || 0;
                        const completedThisMonth = task.completedDates.some(dateStr => {
                            const completedMonth = parseInt(dateStr.split('-')[1], 10) - 1;
                            const completedYear = parseInt(dateStr.split('-')[0], 10);
                            return completedMonth === month && completedYear === year;
                        });

                        if (completedThisMonth) {
                             completedTime += task.estimatedTime || 0;
                        }

                    } else if (task.type === 'recurrente' && task.recurrence) {
                        if (task.recurrence.type === 'weekly' && task.recurrence.days) {
                            for (let day = 1; day <= daysInMonth; day++) {
                                const date = new Date(Date.UTC(year, month, day));
                                if (task.recurrence.days.includes(String(date.getUTCDay()))) {
                                    totalTime += task.estimatedTime;
                                    const dateString = toISODateString(date);
                                    if (task.completedDates.includes(dateString)) {
                                        completedTime += task.estimatedTime;
                                    }
                                }
                            }
                        } else if (task.recurrence.type === 'monthly' && task.recurrence.dayOfMonth) {
                            const dayOfMonth = parseInt(task.recurrence.dayOfMonth);
                            if (dayOfMonth > 0 && dayOfMonth <= daysInMonth) {
                                totalTime += task.estimatedTime;
                                const date = new Date(Date.UTC(year, month, dayOfMonth));
                                const dateString = toISODateString(date);
                                if (task.completedDates.includes(dateString)) {
                                    completedTime += task.estimatedTime;
                                }
                            }
                        }
                    } else if ((task.type === 'flexible' || task.type === 'anual') && !task.recurrence) {
                        const monthStartStr = toISODateString(new Date(Date.UTC(year, month, 1)));
                        const monthEndStr = toISODateString(new Date(Date.UTC(year, month + 1, 0)));

                        if (task.startDate <= monthEndStr && task.dueDate >= monthStartStr) {
                            totalTime += task.estimatedTime || 0;
                            if (task.status === 'completada' && task.completionDate) {
                                const completionMonth = parseInt(task.completionDate.split('-')[1], 10) - 1;
                                const completionYear = parseInt(task.completionDate.split('-')[0], 10);
                                if (completionMonth === month && completionYear === year) {
                                    completedTime += task.estimatedTime || 0;
                                }
                            }
                        }
                    } else { 
                         if (task.dueDate) {
                             const taskMonth = parseInt(task.dueDate.split('-')[1], 10) - 1;
                             const taskYear = parseInt(task.dueDate.split('-')[0], 10);
                             if(taskMonth === month && taskYear === year) {
                                totalTime += task.estimatedTime || 0;
                                if(task.status === 'completada'){
                                    completedTime += task.estimatedTime || 0;
                                }
                             }
                         }
                    }
                });

                employeeReportEl.innerHTML += `
                    <div class="p-3 bg-gray-100 rounded-lg">
                        <p class="font-semibold">${employee.name}</p>
                        <p class="text-sm text-gray-600">Tiempo Total: <strong>${formatTime(totalTime)}</strong></p>
                        <p class="text-sm text-green-700">Tiempo Completado: <strong>${formatTime(completedTime)}</strong></p>
                        <div class="w-full bg-gray-300 rounded-full h-2.5 mt-2">
                            <div class="bg-green-500 h-2.5 rounded-full" style="width: ${totalTime > 0 ? (completedTime / totalTime) * 100 : 0}%"></div>
                        </div>
                    </div>`;
            });
        };

        const updateLockUI = () => {
            const lockedIcon = `<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>`;
            const unlockedIcon = `<svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>`;
            lockBtn.innerHTML = isLocked ? lockedIcon : unlockedIcon;
            if (isLocked) {
                appContainer.classList.add('app-locked');
            } else {
                appContainer.classList.remove('app-locked');
            }
        };
        
        const updateAdminUI = () => {
            if(isAdminSession) {
                adminControls.classList.remove('hidden');
            } else {
                adminControls.classList.add('hidden');
            }
        };

        // --- GESTIÓN DE EMPLEADOS ---
        async function handleAddNewEmployee(e) {
            e.preventDefault();
            if (isLocked) { promptForPassword(); return; }
            const name = newEmployeeNameInput.value.trim();
            if (name) {
                const newId = employees.length > 0 ? Math.max(...employees.map(emp => emp.id)) + 1 : 1;
                employees.push({ id: newId, name: name });
                await savePharmacyData();
                newEmployeeNameInput.value = '';
            }
        };

        async function handleDeleteEmployee(id) {
            if (isLocked) { promptForPassword(); return; }
            if (confirm('¿Seguro que quieres eliminar este empleado? Las tareas que tenga asignadas quedarán sin asignar.')) {
                employees = employees.filter(emp => emp.id !== id);
                tasks.forEach(task => {
                    if (task.assignedTo === id) {
                        task.assignedTo = null;
                    }
                });
                await savePharmacyData();
            }
        };

        // --- MODALES ---
        const openModal = (task = null, dateString = null) => {
            if(isLocked) { promptForPassword(); return; }
            const modalContent = taskModal.querySelector('div');
            taskForm.reset();
            document.querySelectorAll('#task-recurrence-days input').forEach(cb => cb.checked = false);
            ['task-id', 'task-status', 'task-instance-date'].forEach(id => document.getElementById(id).value = '');
            if(dateString) document.getElementById('task-instance-date').value = dateString;
            
            if (task) { // Editar
                document.getElementById('task-type').value = task.type;
                 if (task.recurrence) {
                    document.getElementById('task-recurrence-type').value = task.recurrence.type || 'weekly';
                }
                updateModalUI(); 
                
                document.getElementById('modal-title').textContent = 'Editar Tarea';
                document.getElementById('task-id').value = task.id;
                document.getElementById('task-title').value = task.title;
                document.getElementById('task-start-date').value = task.startDate || '';
                document.getElementById('task-due-date').value = task.dueDate || '';
                document.getElementById('task-assigned-to').value = task.assignedTo || '';
                document.getElementById('task-time').value = task.estimatedTime || '';
                document.getElementById('task-url').value = task.url || '';
                
                if (task.recurrence) {
                     if (task.recurrence.type === 'monthly' && task.type === 'recurrente') {
                        document.getElementById('task-recurrence-day-month').value = task.recurrence.dayOfMonth;
                    } else if (task.recurrence.type === 'weekly' && task.recurrence.days) {
                         task.recurrence.days.forEach(day => {
                            const cb = document.querySelector(`#task-recurrence-days input[value="${day}"]`);
                            if (cb) cb.checked = true;
                        });
                    }
                }
                
                document.getElementById('delete-task-btn').classList.remove('hidden');
                const toggleBtn = document.getElementById('toggle-status-btn');
                toggleBtn.classList.remove('hidden');

                let isCompletedToday = false;
                 if (task.recurrence || task.type === 'flexible') {
                     if (task.type === 'flexible' && !task.recurrence) {
                        isCompletedToday = task.status === 'completada';
                    } else {
                        isCompletedToday = dateString && task.completedDates.includes(dateString);
                    }
                } else {
                    isCompletedToday = task.status === 'completada';
                }

                toggleBtn.textContent = isCompletedToday ? 'Marcar Pendiente' : 'Marcar Completada';
                toggleBtn.className = `px-4 py-2 rounded-lg font-medium ${isCompletedToday ? 'bg-yellow-100 text-yellow-800 hover:bg-yellow-200' : 'bg-green-100 text-green-800 hover:bg-green-200'}`;

            } else { // Crear
                document.getElementById('modal-title').textContent = 'Nueva Tarea';
                document.getElementById('task-status').value = 'pendiente';
                updateModalUI();
                if(dateString) {
                    document.getElementById('task-start-date').value = dateString;
                    document.getElementById('task-due-date').value = dateString;
                }
                document.getElementById('delete-task-btn').classList.add('hidden');
                document.getElementById('toggle-status-btn').classList.add('hidden');
            }

            taskModal.classList.remove('hidden');
            taskModal.classList.add('flex');
            setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 50);
        };

        const closeModal = (modalEl) => {
            const modalContent = modalEl.querySelector('div');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { modalEl.classList.add('hidden'); modalEl.classList.remove('flex'); }, 200);
        };

        const updateModalUI = () => {
            const type = document.getElementById('task-type').value;
            const recurrenceType = document.getElementById('task-recurrence-type').value;

            const canBeRecurrent = type === 'recurrente' || type === 'flexible';
            document.getElementById('recurrence-container').classList.toggle('hidden', !canBeRecurrent);
            
            document.getElementById('dates-container').classList.toggle('hidden', type === 'recurrente');
            
            if (canBeRecurrent) {
                const isWeekly = recurrenceType === 'weekly';
                recurrenceWeeklyContainer.classList.toggle('hidden', !isWeekly || type === 'flexible');
                recurrenceMonthlyContainer.classList.toggle('hidden', isWeekly || type === 'flexible');
            }

            const startDateContainer = document.getElementById('start-date-container');
            const dueDateContainer = document.getElementById('due-date-container');
            const startDateInput = document.getElementById('task-start-date');
            const dueDateInput = document.getElementById('task-due-date');
            const startDateLabel = startDateContainer.querySelector('label');
            const dueDateLabel = dueDateContainer.querySelector('label');

            if (startDateInput.type !== 'date') {
                startDateInput.type = 'date';
                ['min', 'max', 'placeholder'].forEach(attr => startDateInput.removeAttribute(attr));
                dueDateInput.type = 'date';
                ['min', 'max', 'placeholder'].forEach(attr => dueDateInput.removeAttribute(attr));
            }

            if (type === 'flexible' && recurrenceType === 'monthly') {
                startDateInput.type = 'number';
                dueDateInput.type = 'number';
                startDateInput.min = 1; startDateInput.max = 31;
                dueDateInput.min = 1; dueDateInput.max = 31;
                startDateLabel.textContent = 'Día de Inicio';
                dueDateLabel.textContent = 'Día de Fin';
                startDateContainer.style.display = 'block';
            } else {
                startDateLabel.textContent = 'Fecha Inicio';
                dueDateLabel.textContent = 'Fecha Fin';
                const isRange = type === 'flexible' || type === 'anual';
                startDateContainer.style.display = isRange ? 'block' : 'none';
                dueDateLabel.textContent = isRange ? 'Fecha Fin' : 'Fecha';
            }
        };
        
        const getEmployeeNameById = (id) => employees.find(e => e.id === id)?.name || 'Sin asignar';

        const openCompletedModal = () => {
            const modalContent = completedTasksModal.querySelector('div');
            let allCompletedInstances = [];

            tasks.forEach(task => {
                if (task.status === 'completada' && !task.recurrence) {
                    allCompletedInstances.push({
                        title: task.title,
                        assignedTo: getEmployeeNameById(task.assignedTo),
                        completionDate: new Date(task.completionDate || task.dueDate)
                    });
                } else if (task.recurrence) {
                    task.completedDates.forEach(dateStr => {
                        allCompletedInstances.push({
                            title: task.title,
                            assignedTo: getEmployeeNameById(task.assignedTo),
                            completionDate: new Date(dateStr)
                        });
                    });
                }
            });

            allCompletedInstances.sort((a, b) => b.completionDate - a.completionDate);

            if(allCompletedInstances.length === 0) {
                completedTasksListEl.innerHTML = '<p class="text-gray-500 text-center">No hay tareas completadas.</p>';
            } else {
                completedTasksListEl.innerHTML = `
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50">
                            <tr><th class="p-2">Tarea</th><th class="p-2">Completada por</th><th class="p-2">Fecha de Finalización</th></tr>
                        </thead>
                        <tbody>
                        ${allCompletedInstances.map(instance => `
                            <tr class="border-b">
                                <td class="p-2 font-medium">${instance.title}</td>
                                <td class="p-2">${instance.assignedTo}</td>
                                <td class="p-2">${new Date(instance.completionDate.getTime() + instance.completionDate.getTimezoneOffset() * 60000).toLocaleDateString()}</td>
                            </tr>
                        `).join('')}
                        </tbody>
                    </table>`;
            }

            completedTasksModal.classList.remove('hidden');
            completedTasksModal.classList.add('flex');
            setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 50);
        };
        
        // --- GESTIÓN DE CONTRASEÑA ---
        const promptForPassword = () => {
            const modalContent = passwordModal.querySelector('div');
            const input = document.getElementById('password-input');
            const errorEl = document.getElementById('password-error');
            errorEl.textContent = '';
            input.value = '';

            passwordModal.classList.remove('hidden');
            passwordModal.classList.add('flex');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                input.focus();
            }, 50);
        };

        const openChangePasswordModal = () => {
            if (isLocked) { promptForPassword(); return; }
            const modalContent = changePasswordModal.querySelector('div');
            const title = document.getElementById('change-password-title');
            const adminResetContainer = document.getElementById('admin-reset-container');
            const adminResetSelect = document.getElementById('admin-reset-pharmacy-select');
            
            changePasswordForm.reset();
            document.getElementById('change-password-error').textContent = '';

            if(isAdminSession) {
                title.textContent = 'Gestión de Contraseñas (Admin)';
                adminResetContainer.classList.remove('hidden');
                adminResetSelect.innerHTML = `<option value="">-- Cambiar mi contraseña de Admin --</option>`;
                allPharmacies.forEach(p => {
                    adminResetSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                });
            } else {
                title.textContent = 'Cambiar Contraseña de Gerente';
                adminResetContainer.classList.add('hidden');
            }

            changePasswordModal.classList.remove('hidden');
            changePasswordModal.classList.add('flex');
            setTimeout(() => {
                 modalContent.classList.remove('scale-95', 'opacity-0');
                 document.getElementById('current-password').focus();
            }, 50);
        };

        // --- GESTIÓN DE FARMACIAS (ADMIN) ---
        const openManagePharmaciesModal = () => {
            const modalContent = managePharmaciesModal.querySelector('div');
            populatePharmacyManagementList();
            managePharmaciesModal.classList.remove('hidden');
            managePharmaciesModal.classList.add('flex');
            setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 50);
        };
        
        const populatePharmacyManagementList = () => {
            pharmacyManagementList.innerHTML = '';
            allPharmacies.forEach(p => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 border-b';
                item.dataset.pharmacyId = p.id;
                item.innerHTML = `
                    <span class="pharmacy-name">${p.name}</span>
                    <div class="edit-controls hidden">
                        <input type="text" value="${p.name}" class="border-gray-300 rounded-lg shadow-sm text-sm">
                        <button class="save-name-btn text-green-600 p-1">Guardar</button>
                        <button class="cancel-edit-btn text-red-600 p-1">Cancelar</button>
                    </div>
                    <button class="edit-name-btn text-blue-600 text-sm">Editar</button>
                `;
                pharmacyManagementList.appendChild(item);
            });
        };
        
        async function handlePharmacyManagementClick(e) {
            const target = e.target;
            const item = target.closest('[data-pharmacy-id]');
            if (!item) return;
            const pharmacyId = parseInt(item.dataset.pharmacyId);

            if (target.classList.contains('edit-name-btn')) {
                item.querySelector('.pharmacy-name').classList.add('hidden');
                target.classList.add('hidden');
                item.querySelector('.edit-controls').classList.remove('hidden');
            }
            if (target.classList.contains('cancel-edit-btn')) {
                item.querySelector('.pharmacy-name').classList.remove('hidden');
                item.querySelector('.edit-name-btn').classList.remove('hidden');
                item.querySelector('.edit-controls').classList.add('hidden');
            }
            if (target.classList.contains('save-name-btn')) {
                const newName = item.querySelector('input').value.trim();
                if(newName) {
                    const pharmacy = allPharmacies.find(p => p.id === pharmacyId);
                    if(pharmacy) {
                        pharmacy.name = newName;
                        await saveAllPharmacies();
                        populatePharmacyManagementList();
                        populateLoginSelect();
                         if(currentPharmacyId === pharmacyId) {
                            pharmacyNameHeader.textContent = newName;
                        }
                        showToast('Nombre de farmacia actualizado.', 'success');
                    }
                }
            }
        };

        async function handleAddNewPharmacy(e) {
            e.preventDefault();
            const newNameInput = document.getElementById('new-pharmacy-name');
            const newName = newNameInput.value.trim();
            if (newName) {
                const newId = allPharmacies.length > 0 ? Math.max(...allPharmacies.map(p => p.id)) + 1 : 1;
                allPharmacies.push({ id: newId, name: newName });
                await saveAllPharmacies();
                populatePharmacyManagementList();
                populateLoginSelect();
                newNameInput.value = '';
                showToast('Farmacia añadida con éxito.', 'success');
            }
        };


        // --- NOTIFICACIONES ---
        const showToast = (message, type = 'error') => {
            const colors = {
                error: 'bg-red-600',
                success: 'bg-green-600'
            };
            const toast = document.createElement('div');
            toast.className = `toast ${colors[type]} text-white font-bold p-4 rounded-lg shadow-lg`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 5500);
        };

        const checkDueTasks = () => {
            const today = toISODateString(new Date());
            tasks.forEach(task => {
                if (task.type === 'inaplazable' && task.dueDate === today && task.status === 'pendiente') {
                    showToast(`¡ATENCIÓN! La tarea "${task.title}" vence hoy.`);
                }
            });
        };

        const showLoginScreen = () => {
            loadingScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            loginScreen.classList.add('flex');
            appContainer.classList.add('hidden');
            appContainer.classList.remove('flex');
            populateLoginSelect();
        };

        const populateLoginSelect = () => {
            pharmacySelect.innerHTML = '';
            // Ordenar farmacias alfabéticamente
            allPharmacies.sort((a, b) => a.name.localeCompare(b.name));
            allPharmacies.forEach(p => {
                pharmacySelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
        };

        const showAppScreen = () => {
            loadingScreen.classList.add('hidden');
            loginScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            appContainer.classList.add('flex');
            const pharmacy = allPharmacies.find(p => p.id === currentPharmacyId);
            pharmacyNameHeader.textContent = pharmacy ? pharmacy.name : 'Farmacia Desconocida';
        }

        // --- INICIALIZACIÓN Y EVENTOS ---
        async function init() {
            // Inicializar Firebase
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            
            const app = window.firebase.initializeApp(firebaseConfig);
            db = window.firebase.getFirestore(app);
            auth = window.firebase.getAuth(app);
            
            try {
                if (typeof __initial_auth_token !== 'undefined') {
                    await window.firebase.signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await window.firebase.signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error de autenticación en Firebase:", error);
                loadingScreen.innerHTML = '<p class="text-red-500">Error de autenticación. No se puede conectar a la base de datos.</p>';
                return;
            }
            
            await loadGlobalData();
            
            const sessionPharmacyId = sessionStorage.getItem('session_pharmacyId');
            if(sessionPharmacyId){
                currentPharmacyId = parseInt(sessionPharmacyId);
                isAdminSession = sessionStorage.getItem('session_isAdmin') === 'true';
                isLocked = false;
                listenToPharmacyData(currentPharmacyId);
                showAppScreen();
            } else {
                showLoginScreen();
            }

            // Navegación Calendario
            document.getElementById('prev-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderAll(); });
            document.getElementById('next-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderAll(); });
            
            // Filtros
            filterEmployeeSelect.addEventListener('change', (e) => { filters.employee = e.target.value; renderCalendar(); });
            filterTypeSelect.addEventListener('change', (e) => { filters.type = e.target.value; renderCalendar(); });
            document.getElementById('clear-filters-btn').addEventListener('click', () => { filters = { employee: 'all', type: 'all' }; filterEmployeeSelect.value = 'all'; filterTypeSelect.value = 'all'; renderAll(); });

            // Gestión Empleados
            addEmployeeForm.addEventListener('submit', handleAddNewEmployee);
            employeeListEl.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    handleDeleteEmployee(parseInt(e.target.dataset.id));
                }
            });

            // Modales y Botones
            document.getElementById('addTaskBtn').addEventListener('click', () => openModal());
            printViewBtn.addEventListener('click', () => window.print());
            document.getElementById('cancel-btn').addEventListener('click', () => closeModal(taskModal));
            taskModal.addEventListener('click', (e) => { if (e.target === taskModal) closeModal(taskModal); });
            document.getElementById('task-type').addEventListener('change', updateModalUI);
            taskRecurrenceType.addEventListener('change', updateModalUI);
            reviewCompletedBtn.addEventListener('click', openCompletedModal);
            closeCompletedModalBtn.addEventListener('click', () => closeModal(completedTasksModal));
            completedTasksModal.addEventListener('click', (e) => { if (e.target === completedTasksModal) closeModal(completedTasksModal); });
            
            // Login/Logout y Seguridad
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const selectedPharmacyId = parseInt(pharmacySelect.value);
                const password = document.getElementById('login-password').value;
                const passHash = hashCode(password);
                const errorEl = document.getElementById('login-error');
                errorEl.textContent = '';

                if (!allPasswords.admin) {
                    allPasswords.admin = passHash;
                    await savePasswords();
                    showToast('Contraseña de Administrador establecida.', 'success');
                    document.getElementById('initial-setup-message').classList.add('hidden');
                }

                const isAdmin = passHash === allPasswords.admin;
                const isManager = passHash === allPasswords[`manager_${selectedPharmacyId}`];

                if (isAdmin || isManager) {
                    currentPharmacyId = selectedPharmacyId;
                    isAdminSession = isAdmin;
                    isLocked = false;
                    
                    sessionStorage.setItem('session_pharmacyId', currentPharmacyId);
                    sessionStorage.setItem('session_isAdmin', isAdminSession);
                    
                    listenToPharmacyData(currentPharmacyId);
                    showAppScreen();
                    checkDueTasks();
                } else {
                    errorEl.textContent = 'Contraseña incorrecta.';
                }
            });

            logoutBtn.addEventListener('click', () => {
                unsubscribePharmacyData(); // Dejar de escuchar cambios
                sessionStorage.removeItem('session_pharmacyId');
                sessionStorage.removeItem('session_isAdmin');
                currentPharmacyId = null;
                isAdminSession = false;
                isLocked = true;
                tasks = [];
                employees = [];
                showLoginScreen();
            });

            lockBtn.addEventListener('click', () => {
                if(isLocked) {
                    promptForPassword();
                } else {
                    isLocked = true;
                    updateLockUI();
                }
            });

            changePasswordBtn.addEventListener('click', openChangePasswordModal);
            
            passwordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const input = document.getElementById('password-input').value;
                const passHash = hashCode(input);
                const errorEl = document.getElementById('password-error');
                
                const isAdmin = passHash === allPasswords.admin;
                const isManager = passHash === allPasswords[`manager_${currentPharmacyId}`];

                if(isAdmin || isManager) {
                    isLocked = false;
                    isAdminSession = isAdmin; 
                    sessionStorage.setItem('session_isAdmin', isAdminSession);
                    updateLockUI();
                    updateAdminUI();
                    closeModal(passwordModal);
                } else {
                    errorEl.textContent = 'Contraseña incorrecta.';
                }
            });

            document.getElementById('cancel-password-btn').addEventListener('click', () => closeModal(passwordModal));

            changePasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const currentPass = document.getElementById('current-password').value;
                const newPass = document.getElementById('new-password').value;
                const errorEl = document.getElementById('change-password-error');
                const resetPharmacyId = document.getElementById('admin-reset-pharmacy-select').value;
                
                if (isAdminSession) {
                    if(hashCode(currentPass) !== allPasswords.admin) {
                        errorEl.textContent = 'La contraseña de Admin es incorrecta.';
                        return;
                    }
                    if (resetPharmacyId) {
                        allPasswords[`manager_${resetPharmacyId}`] = hashCode(newPass);
                        showToast(`Contraseña para ${allPharmacies.find(p=>p.id==resetPharmacyId).name} cambiada.`, 'success');
                    } else { 
                        allPasswords.admin = hashCode(newPass);
                        showToast('Contraseña de Administrador cambiada.', 'success');
                    }
                } else {
                    if(hashCode(currentPass) !== allPasswords[`manager_${currentPharmacyId}`]) {
                         errorEl.textContent = 'La contraseña actual es incorrecta.';
                         return;
                    }
                    allPasswords[`manager_${currentPharmacyId}`] = hashCode(newPass);
                    showToast('Contraseña de Gerente cambiada.', 'success');
                }

                await savePasswords();
                closeModal(changePasswordModal);
            });
            document.getElementById('cancel-change-password-btn').addEventListener('click', () => closeModal(changePasswordModal));

            // Admin: Gestión de Farmacias
            managePharmaciesBtn.addEventListener('click', openManagePharmaciesModal);
            closeManagePharmaciesModalBtn.addEventListener('click', () => closeModal(managePharmaciesModal));
            addPharmacyForm.addEventListener('submit', handleAddNewPharmacy);
            pharmacyManagementList.addEventListener('click', handlePharmacyManagementClick);

            // Lógica del formulario de tareas
            taskForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('task-id').value);
                const type = document.getElementById('task-type').value;
                
                let taskData = {
                    id: id || Date.now(),
                    title: document.getElementById('task-title').value,
                    type: type,
                    assignedTo: parseInt(document.getElementById('task-assigned-to').value) || null,
                    estimatedTime: parseInt(document.getElementById('task-time').value) || 0,
                    status: 'pendiente',
                    recurrence: null,
                    completedDates: [],
                    completionDate: null,
                    url: document.getElementById('task-url').value.trim() || null
                };

                if(id) {
                    const existingTask = tasks.find(t => t.id === id);
                    if(existingTask) {
                        taskData.status = existingTask.status;
                        taskData.completedDates = existingTask.completedDates;
                        taskData.completionDate = existingTask.completionDate;
                    }
                }

                const recurrenceType = document.getElementById('task-recurrence-type').value;

                if (type === 'recurrente') {
                    if (recurrenceType === 'weekly') {
                        const days = Array.from(document.querySelectorAll('#task-recurrence-days input:checked')).map(cb => cb.value);
                        taskData.recurrence = { type: 'weekly', days: days };
                    } else { 
                        const dayOfMonth = document.getElementById('task-recurrence-day-month').value;
                        taskData.recurrence = { type: 'monthly', dayOfMonth: dayOfMonth };
                    }
                } else if (type === 'flexible' && document.getElementById('recurrence-container').offsetParent !== null && recurrenceType === 'monthly') {
                    taskData.recurrence = { type: 'monthly' };
                    taskData.startDate = document.getElementById('task-start-date').value; 
                    taskData.dueDate = document.getElementById('task-due-date').value; 
                } else { 
                     taskData.startDate = (type === 'flexible' || type === 'anual') ? (document.getElementById('task-start-date').value || null) : (document.getElementById('task-due-date').value || null);
                     taskData.dueDate = document.getElementById('task-due-date').value || null;
                }

                if (id) {
                    const index = tasks.findIndex(t => t.id === id);
                    tasks[index] = taskData;
                }
                else tasks.push(taskData);
                await savePharmacyData();
                closeModal(taskModal);
            });

            document.getElementById('delete-task-btn').addEventListener('click', async () => {
                const id = parseInt(document.getElementById('task-id').value);
                tasks = tasks.filter(t => t.id !== id);
                await savePharmacyData();
                closeModal(taskModal);
            });
            
            document.getElementById('toggle-status-btn').addEventListener('click', async () => {
                const id = parseInt(document.getElementById('task-id').value);
                const instanceDate = document.getElementById('task-instance-date').value;
                const task = tasks.find(t => t.id === id);

                if (!task) return;

                if (task.type === 'flexible' && !task.recurrence) {
                    if (task.status === 'pendiente') {
                        task.status = 'completada';
                        task.completionDate = instanceDate;
                    } else {
                        task.status = 'pendiente';
                        task.completionDate = null;
                    }
                }
                else if (task.recurrence) {
                    if (instanceDate) {
                        const dateIndex = task.completedDates.indexOf(instanceDate);
                        if (dateIndex > -1) {
                            task.completedDates.splice(dateIndex, 1);
                        } else {
                            task.completedDates.push(instanceDate);
                        }
                    }
                }
                else {
                    if (task.status === 'pendiente') {
                        task.status = 'completada';
                        task.completionDate = toISODateString(new Date());
                    } else {
                        task.status = 'pendiente';
                        task.completionDate = null;
                    }
                }
                await savePharmacyData();
                openModal(task, instanceDate);
            });
        };

        init();
    });
    </script>
</body>
</html>

